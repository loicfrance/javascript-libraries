Date.now||(Date.now=function(){return(new Date).getTime()});exists(window.Game)||(Game={});
Game.Manager=function(){GameManager=function(){this.running=!1;this.objects={active:[],toAdd:[],toRemove:[]};this.now=0;this.gameMap=null};GameManager.prototype.setMap=function(a){this.gameMap=a};GameManager.prototype.createMap=function(a,b,e,f){this.gameMap=new Game.Map(a,b,e);this.gameMap.setBgColor(exists(f)?f:"#000")};GameManager.prototype.getMap=function(){return this.gameMap};GameManager.prototype.getObjects=function(a){return exists(a)?this.objects.active.filter(a):this.objects.active};var d=
function(a,b){return b instanceof a};GameManager.prototype.getInstancesOf=function(a){return exists(a)?this.getObjects(d.bind(void 0,a)):this.getObjects()};GameManager.prototype.addObject=function(a){this.objects.toAdd.indexOf(-1==a)?this.objects.toAdd.push(a):console.log(Error("the object "+a+" is already being added from the game").stack)};GameManager.prototype.removeObject=function(a){this.objects.toRemove.indexOf(-1===a)?this.objects.toRemove.push(a):console.log(Error("the object "+a+" is already being removed from the game").stack)};
GameManager.prototype.clearObjects=function(){for(var a=this.objects.active.length;0<=a;a--)this.removeObject(this.objects.active[a])};GameManager.prototype.start=function(){this.running=!0;this.now=0;if(!isNull(this.gameEventsListener)&&!isNull(this.gameEventsListener.onStart))this.gameEventsListener.onStart(this);requestAnimationFrame(this.onFrame.bind(this))};GameManager.prototype.stop=function(){this.running=!1;if(!isNull(this.gameEventsListener)&&!isNull(this.gameEventsListener.onStop))this.gameEventsListener.onStop(this)};
GameManager.prototype.setGameEventsListener=function(a){this.gameEventsListener=a};GameManager.prototype.getGameEventsListener=function(){return this.gameEventsListener};GameManager.prototype.onFrame=function(a){if(this.running){if(0===this.now){this.now=a;requestAnimationFrame(this.onFrame.bind(this));return}var b,e=this.objects.active,f=this.objects.toAdd,g=this.objects.toRemove,d=g.length;if(0<d)for(;d--;)b=g.pop(),b.onDeath(this),b=e.indexOf(b),-1<b&&e.splice(b,1);g=(a-this.now)/1E3;0===g&&console.log("error : dT=0");
this.now=a;if(0!==g&&.5>g){var d,k;a=e.filter(Game.objects.Object.collisionFilter);var l;d=b=a.length;if(0<d)for(;d--;)a[d].prepareCollision();d=b;if(0<d)for(;d--;){b=a.pop();l=a.filter(Game.objects.Object.getCollisionLayerFilter(b.getCollisionLayers(),!0));k=l.length;if(0<k)for(;k--;)b!==l[k]&&b.canCollide(l[k])&&l[k].canCollide(b)&&b.collides(l[k])&&(b.onCollision(this,l[k]),l[k].onCollision(this,b));b.finishCollision()}d=f.length;if(0<d)for(;d--;)e.push(f.pop());d=e.length;if(0<d)for(;d--;)e[d].onFrame(this,
g)}if(!isNull(this.gameEventsListener)&&!isNull(this.gameEventsListener.onFrame))this.gameEventsListener.onFrame(this,g)}this.gameMap&&this.gameMap.render(this,this.objects.active);requestAnimationFrame(this.onFrame.bind(this))};GameManager.prototype.showContextMenu=function(a){a=""+this.gameMap.getContextMenu();var b=this.gameMap.getObjectAt(this.gameMap.gameCoordsFromPixelCoords(position));isNull(b)||(a+=b.getContextMenu());menu.innerHtml=a+""};return GameManager}();Game.Map=function(){var d=function(a,b,e){exists(a.length)||(a=[canvas]);var f=a.length;this.contexts=Array(f);for(0===f&&console.exception("at least one canvas must be attached to the GameMap");0<f--;)this.contexts[f]=a[f].getContext("2d"),this.contexts[f].font="20px Verdana";this.gameWidth=b|a[0].width;this.gameHeight=e|a[0].height;this.visibleRect=new Rect(0,0,this.gameWidth,this.gameHeight)};d.prototype.setBgColor=function(a){var b=this.contexts.length;for(this.contexts[0].canvas.style.background=
a;b--;)this.contexts[b].canvas.style.background="#00000000"};d.prototype.getBg=function(){return this.contexts[0].canvas.style.background};d.prototype.setPointerPosition=function(){switch(arguments.length){case 1:this.pointerPos=new Vec2(arguments[0]);break;case 2:this.pointerPos=new Vec2(x,y)}var a=this.getHud();isNull(a)||a.mouseMove(this.pointerPos)};d.prototype.getPointerPosition=function(){return isNull(this.pointerPos)?Vec2.ZERO:this.pointerPos};d.prototype.useFullWindow=function(a,b){exists(a)?
isNaN(a)||(b=a):a=!0;a=!0;this.onWindowResize&&(window.removeEventListener("resize",this.onWindowResize.bind(this),!1),document.removeEventListener("fullscreenchange",this.onWindowResize.bind(this),!1));if(a){isNaN(b)&&(bordermargin=0);document.body.style.margin=0;console.log("register resize listener");var e=this.getVisibleRect().ratio();this.onWindowResize=function(a,d){for(var h=window.innerWidth-b,k=Math.min(window.innerHeight-b,h/e),h=k*e,l=(window.innerWidth-h)/2,m=(window.innerHeight-k)/2,
n=this.contexts.length,p=h/this.visibleRect.width(),q=k/this.visibleRect.height();n--;)this.contexts[n].canvas.width=h,this.contexts[n].canvas.height=k,this.contexts[n].canvas.style.marginLeft=l.toString()+"px",this.contexts[n].canvas.style.marginTop=m.toString()+"px",this.contexts[n].transform(p,0,0,q,0,0);isNull(hud=this.getHud())||isNull(c=hud.getContext())||(c.width=h,c.height=k,c.canvas.style.marginLeft=l.toString()+"px",c.canvas.style.marginTop=m.toString()+"px",c.transform(p,0,0,q,0,0))};window.addEventListener("resize",
this.onWindowResize.bind(this,!1),!1);document.addEventListener("fullscreenchange",this.onWindowResize.bind(this,!0),!1);this.onWindowResize()}};d.prototype.setVisibleRect=function(a){this.visibleRect.set(a);var b=a.width();a=a.height();b=b?this.contexts[0].canvas.width/b:1;a=a?this.contexts[0].canvas.height/a:1;for(var e=this.contexts.length;e--;)this.contexts[e].transform(b,0,0,a,0,0)};d.prototype.getVisibleRect=function(){return this.visibleRect};d.prototype.getGameRect=function(){return new Rect(0,
0,this.gameWidth,this.gameHeight)};d.prototype.gameCoordsFromPixelCoords=function(a,b){var e=this.getGamePixelScaleX(),f=this.getGamePixelScaleY(),d=this.getVisibleRect().left,h=this.getVisibleRect().top;isNull(b)&&(b={});b.x=a.x*e+d;b.y=a.y*f+h;return b};d.prototype.pixelCoordsFromGameCoords=function(a,b){this.getGamePixelScaleX();this.getGamePixelScaleY();var e=this.getVisibleRect().left,f=this.getVisibleRect().top;isNull(b)&&(b={});return b.set((a.x-e)*scale,a.y-f)};d.prototype.getGamePixelScaleX=
function(){return this.getVisibleRect().width()/this.contexts[0].canvas.width};d.prototype.getGamePixelScaleY=function(){return this.getVisibleRect().height()/this.contexts[0].canvas.height};d.prototype.setHud=function(a){this.hud=a};d.prototype.createHud=function(){this.hud=new Game.hud.Hud};d.prototype.getHud=function(){return this.hud};d.prototype.showDebug=function(a){this.debug=a};d.prototype.isDebug=function(){return this.debug};d.LAYER_NONE=-1;d.LAYER_BG1=0;d.LAYER_BG2=1;d.LAYER_BG3=2;d.LAYER_OBJ1=
3;d.LAYER_OBJ2=4;d.LAYER_OBJ3=5;d.LAYER_PARTCILES=6;d.prototype.getContextForLayer=function(a,b){return this.contexts[a>=b?b-1:a]};d.prototype.render=function(a,b){for(var e=this.getVisibleRect(),f,d=-1,h=this.contexts.length,k=null;6>=d++;){ctx=this.getContextForLayer(d,h);ctx.save();ctx!=k&&(ctx.clearRect(0,0,e.width(),e.height()),k=ctx);f=b.filter(GameObject.renderLayerFilter.bind(void 0,d));var l=f.length;if(0<l)for(;l--;)f[l].isOutOfMap(e)||(f[l].render(ctx),this.debug&&f[l].renderDebug(ctx));
ctx.restore()}this.showMouseOverInfos(a,b,ctx)};d.prototype.getObjectAt=function(a,b){var e=null,f=Number.MAX_SAFE_INTEGER,d,h,k=a.length,l;if(0<k)for(;k--;)l=a[k],isNull(l.renderMouseOver)||(d=l.getPosition()),isNull(d)||(h=Vec2.distance(d,this.pointerPos),h<f&&l.getRenderRect().contains(this.pointerPos)&&(e=l,f=h));return e};d.prototype.getContextMenu=function(){return""};d.prototype.showMouseOverInfos=function(a,b,e){e||(e=this.contexts[this.contexts.length-1]);isNull(this.pointerPos)||(b=this.getObjectAt(b,
this.pointerPos),isNull(b)||b.renderMouseOver(e,this.pointerPos,a,this.debug))};return d}();Game.objects={};
Game.objects.Object=function(){GameObject=function(){};GameObject.prototype.onFrame=function(a,b){this.moveOnFrame&&this.moveOnFrame(a,b);this.accelerateOnFrame&&this.accelerateOnFrame(a,b);this.rotateOnFrame&&this.rotateOnFrame(a,b);this.mustKeepInRect()&&this.maintainInRect(a.gameMap.getVisibleRect())};GameObject.prototype.moveOnFrame=function(a,b){var e=this.getSpeed();exists(e)&&!e.isZero()&&this.move((new Vec2(e)).mul(b))};GameObject.prototype.accelerateOnFrame=function(a,b){var e=this.getAcceleration();
exists(e)&&!e.isZero()&&this.accelerate((new Vec2(e)).mul(b))};GameObject.prototype.rotateOnFrame=function(a,b){var e=this.getRotationSpeed();exists(e)&&0!==e&&this.rotate(e*b)};GameObject.prototype.setRotationFieldEnabled=function(a){a&&!this.radians?this.radians=0:!a&&this.radians&&delete this.radians;return this};GameObject.prototype.rotate=function(a){exists(this.radians)&&(this.radians+=a);this.renderer&&this.renderer.rotate(a);this.collider&&this.collider.rotate(a);return this};GameObject.prototype.setRadians=
function(a){isNaN(a)?console.log("cannot set radians to "+a):(exists(this.radians)||this.setRotationFieldEnabled(!0),this.rotate(a-this.radians))};GameObject.prototype.getRadians=function(){return this.radians||0};GameObject.prototype.getDirection=function(){return Vec2.createFromRadians(this.getRadians())};GameObject.prototype.lookAt=function(a){this.radians||this.setRotationFieldEnabled(!0);a=Vec2.translation(this.getPosition(),a);this.setRadians(a.getAngle());return this};GameObject.prototype.setRotationSpeed=
function(a){0===a?this.rotationSpeed&&delete this.rotationSpeed:this.rotationSpeed=a;return this};GameObject.prototype.getRotationSpeed=function(){return this.rotationSpeed||0};GameObject.prototype.grow=function(a){this.renderer&&this.renderer.grow(a);this.collider&&this.collider.grow(a);return this};GameObject.prototype.setRenderer=function(a){this.renderer=a;return this};GameObject.prototype.getRenderer=function(){return this.renderer};GameObject.prototype.render=function(a){this.renderer&&this.renderer.render(this.getPosition(),
a)};GameObject.prototype.renderDebug=function(a){this.collider&&this.collider.render(this.getPosition(),a)};GameObject.prototype.renderMouseOver=function(a,b,e,f){!e.running&&f&&(b=this.getRect(),a.fillStyle="#fff",a.font="15px Verdana",e=this.getInformations(),a.wrapText(e.join("\n"),b.right,b.top,200,12));a.strokeStyle="#fff";(new Circle(this.getPosition(),1.1*this.getRenderRadius())).draw(a,!1,!0)};GameObject.prototype.getInformations=function(){var a=this.getPosition(),b=this.getSpeed(),e=this.getAcceleration(),
f=[];isNull(a)||f.push(["p :",a.roundedVec(4)].join(" "));isNull(b)||f.push(["s :",b.roundedVec(4)].join(" "));isNull(e)||f.push(["a :",e.roundedVec(4)].join(" "));return f};GameObject.prototype.getContextMenu=function(){return""};GameObject.prototype.getRenderLayer=function(){return Game.Map.LAYER_OBJ1};GameObject.renderLayerFilter=function(a,b){return b.getRenderLayer()==a};GameObject.prototype.setCollider=function(a){this.collider=a;return this};GameObject.prototype.getCollider=function(){return this.collider};
GameObject.prototype.canCollide=function(){return!isNull(this.getCollider())};GameObject.prototype.prepareCollision=function(){this.collision={position:this.getPosition(),collider:this.getCollider()};this.collision.collider.prepareCollision(this.collision.position)};GameObject.prototype.finishCollision=function(){this.collision.collider.finishCollision();delete this.collision};GameObject.prototype.collides=function(a){return isNull(this.collision.position)||isNull(a.collision.position)?!1:this.collision.collider.collides(this.collision.position,
a.collision.position,a.collision.collider)};GameObject.prototype.onCollision=function(a,b){};GameObject.COLLISION_LAYER=0;var d=[GameObject.COLLISION_LAYER];GameObject.prototype.getCollisionLayers=function(){return d};GameObject.prototype.isInLayer=function(a){return 0<=this.getCollisionLayers().indexOf(a)};GameObject.getCollisionLayerFilter=function(a,b){if(exists(a.length)){var e=a.length-1;return function(f){var d=e;if(0<d)for(;d--;)if(0<=f.getCollisionLayers().indexOf(a[d]))return b;return!b}}return b?
function(b){return 0<=b.getCollisionLayers().indexOf(a)}:function(b){return-1==b.getCollisionLayers().indexOf(a)}};GameObject.collisionFilter=GameObject.getCollisionLayerFilter(-1,!1);GameObject.prototype.getRect=function(){return Rect.getUnion(this.getRenderRect(),this.getColliderRect())};GameObject.prototype.getColliderRect=function(){var a=this.getCollider();return a?a.getRect(this.getPosition()):Rect.createFromPoint(this.getPosition())};GameObject.prototype.getRenderRect=function(){var a=this.getRenderer();
return a?a.getRect(this.getPosition()):Rect.createFromPoint(this.getPosition())};GameObject.prototype.getRadius=function(){return Math.max(this.getRenderRadius(),this.getColliderRadius())};GameObject.prototype.getRenderRadius=function(){var a=this.getRenderer();return a?a.getRadius():0};GameObject.prototype.getColliderRadius=function(){var a=this.getCollider();return a?a.getRadius():0};GameObject.prototype.getCircle=function(){return new Circle(this.getPosition(),this.getRadius())};GameObject.prototype.getRenderCircle=
function(){return new Circle(this.getPosition(),this.getRenderRadius())};GameObject.prototype.getColliderCircle=function(){return new Circle(this.getPosition(),this.getColliderRadius())};GameObject.prototype.getPosition=function(){return this.position};GameObject.prototype.getSpeed=function(){return this.speed};GameObject.prototype.getAcceleration=function(){return this.accel};GameObject.prototype.copyPosition=function(){return new Vec2(this.getPosition())};GameObject.prototype.copySpeed=function(){return new Vec2(this.getSpeed())};
GameObject.prototype.copyAcceleration=function(){return new Vec2(this.getAcceleration())};GameObject.prototype.setPosition=function(){var a=this.getPosition();a?a.set.apply(a,arguments):this.position=1==arguments.length?new Vec2(arguments[0]):new Vec2(arguments[0],arguments[1]);return this};GameObject.prototype.setSpeed=function(){var a=this.getSpeed();a?a.set.apply(a,arguments):this.speed=1==arguments.length?new Vec2(arguments[0]):new Vec2(arguments[0],arguments[1]);return this};GameObject.prototype.setAcceleration=
function(){var a=this.getAcceleration();a?a.set.apply(a,arguments):this.accel=1==arguments.length?new Vec2(arguments[0]):new Vec2(arguments[0],arguments[1]);return this};GameObject.prototype.move=function(){var a=this.getPosition();a&&this.setPosition(a.add.apply(a,arguments));return this};GameObject.prototype.accelerate=function(){var a=this.getSpeed();a&&this.setSpeed(a.add.apply(a,arguments));return this};GameObject.prototype.kill=function(a){a.removeObject(this)};GameObject.prototype.onDeath=
function(a){delete this.position;delete this.speed;delete this.accel;this.renderer&&delete this.renderer;this.collider&&delete this.collider};GameObject.prototype.isOutOfMap=function(a,b,e){a=a.clone();isNull(b)||a.addMargin(-b,exists(e)?-e:-b);if(b=this.getPosition()){if(a.contains(b))return 0;a.addMargin(this.getRadius());e=0;b.x<a.left?e|=1:b.x>a.right&&(e|=4);b.y<a.top?e|=2:b.y>a.bottom&&(e|=8);return e}return 0};GameObject.prototype.maintainInRect=function(a,b,e){b&&(a=a.clone().addMargin(-b,
exists(e)?-e:-b));var f=this.getRect();b=this.getPosition();e=this.getSpeed();var d=f.left<a.left?a.left-f.left:f.right>a.right?a.right-f.right:0;a=f.top<a.top?a.top-f.top:f.bottom>a.bottom?a.bottom-f.bottom:0;0!==d&&(b.x+=d,0<e.x&&0>d||0>e.x&&0<d)&&(e.x=0);0!==a&&(b.y+=a,0<e.y&&0>a||0>e.y&&0<a)&&(e.y=0)};GameObject.prototype.mustKeepInRect=function(){return!1};GameObject.prototype.toString=function(){return["object at",this.getPosition()].join(" ")};GameObject.Static=function(a){GameObject.call(this);
this.setPosition(a?a:Vec2.ZERO)};classExtend(GameObject,GameObject.Static);GameObject.Cinetic=function(a){GameObject.Static.call(this,a);this.setSpeed(Vec2.ZERO)};classExtend(GameObject.Static,GameObject.Cinetic);GameObject.Dynamic=function(a){GameObject.Cinetic.call(this,a);this.setAcceleration(Vec2.ZERO)};classExtend(GameObject.Cinetic,GameObject.Dynamic);return GameObject}();Game.objects.renderers=function(){var d={};d.Renderer=function(){var a=function(){};a.prototype.rotate=function(a){};a.prototype.grow=function(a){};a.prototype.render=function(a,e){};a.prototype.getRadius=function(){return 0};a.prototype.getRect=function(a){return Rect.createFromPoint(a)};return a}();d.Shaped=function(){parent=d.Renderer;ShapedRenderer=function(a,b){this.shape=a.clone();this.color=b;this.fill=!0};classExtend(parent,ShapedRenderer);ShapedRenderer.prototype.rotate=function(a){this.shape.rotate(a)};
ShapedRenderer.prototype.grow=function(a){this.shape.grow(a)};ShapedRenderer.prototype.getColor=function(){return this.color};ShapedRenderer.prototype.setColor=function(a){this.color=a};ShapedRenderer.prototype.setShape=function(a){this.shape=a.clone()};ShapedRenderer.prototype.getShape=function(){return this.shape};ShapedRenderer.prototype.render=function(a,b){this.fill&&(b.fillStyle=this.color);this.stroke&&(b.strokeStyle=this.color);this.shape.moveTo(a);this.shape.draw(b,this.fill,this.stroke)};
ShapedRenderer.prototype.getRect=function(a){this.shape.moveTo(a);return this.shape.getRect()};ShapedRenderer.prototype.getRadius=function(){return this.shape.getRadius()};return ShapedRenderer}();return d}();Game.objects.colliders=function(){var d={},a=function(){var a=function(){};a.prototype.rotate=function(a){};a.prototype.grow=function(a){};a.prototype.getRadius=function(){return 0};a.prototype.getRect=function(a){return Rect.createFromPoint(a)};a.prototype.collidesWhenInside=function(a){return!1};a.prototype.prepareCollision=function(a){this.collision={rect:this.getRect(a)}};a.prototype.finishCollision=function(){delete this.collision};a.prototype.collides=function(a,b,d){return!1};return a}();d.Collider=
a;d.Collider.prototype=a.prototype;a=function(){parent=d.Collider;var a=function(a){this.shape=a.clone()};classExtend(parent,a);a.prototype.rotate=function(a){this.shape.rotate(a)};a.prototype.grow=function(a){this.shape.grow(a)};a.prototype.getShape=function(){return this.shape};a.prototype.setShape=function(a){this.shape=a.clone()};a.prototype.collides=function(a,b,d){return!isNull(d.shape)&&d.collision.rect.overlap(this.collision.rect)&&this.shape.intersect(d.shape)||this.collidesWhenInside(d)&&
d.shape.contains(a)||d.collidesWhenInside(this)&&this.shape.contains(b)};a.prototype.getRect=function(a){a&&this.shape.moveTo(a);return this.shape.getRect()};a.prototype.getRadius=function(){return this.shape.getRadius()};a.prototype.render=function(a,b){b.strokeStyle="#ff0000";this.getRect(a).draw(b,!1,!0);this.shape.draw(b,!1,!0)};return a}();d.Shaped=a;d.Shaped.prototype=a.prototype;return d}();Game.objects.properties={};
Game.objects.properties.Health={isDamageable:function(d){return exists(d.receiveDamages)},applyOnClass:function(d){d.prototype.receiveDamages=function(a,b,d){if(0>=this.health)return!1;this.health-=d;0>=this.health&&this.kill(a);return!0};d.prototype.heal=function(a){this.health+=a;!isNull(this.maxHealth)&&this.health>this.maxHealth&&(this.health=this.maxHealth)};d.prototype.setHealth=function(a){this.health=a};d.prototype.getHealth=function(){return this.health};var a=override(d,"getInformations",
function(){var b=a.call(this);b.push(["health :",this.health.toPrecision(4)].join(" "));return b});d.prototype.setMaxHealth=function(a){this.maxHealth=a};d.prototype.getMaxHealth=function(){return this.maxHealth};var b=override(d,"onDeath",function(a){b.call(a);isNull(this.maxHealth)||delete this.maxHealth;delete this.health})}};
Game.objects.properties.Energy={applyOnClass:function(d){d.prototype.useEnergy=function(a){if(this.getEnergy()<a)return!1;this.setEnergy(this.getEnergy()-a);return!0};d.prototype.setMaxEnergy=function(a){this.maxEnergy=a};d.prototype.setEnergy=function(a){this.energy=a};d.prototype.recoverEnergy=function(a){if(this.isEnergyFull())return!1;this.setEnergy(this.getEnergy()+a);this.isEnergyFull()&&this.setEnergy(this.getMaxEnergy());return!0};d.prototype.isEnergyFull=function(){return this.getEnergy()>=
this.getMaxEnergy()};d.prototype.setEnergyRecoverSpeed=function(a){this.energyRecoverSpeed=a};d.prototype.getMaxEnergy=function(){return this.maxEnergy};d.prototype.getEnergy=function(){return this.energy};d.prototype.getEnergyRecoverSpeed=function(){return this.energyRecoverSpeed};var a=override(d,"onFrame",function(b,e){a.call(this,b,e);var d=this.getEnergyRecoverSpeed();d&&!this.isEnergyFull()&&this.recoverEnergy(d*e)}),b=override(d,"getInformations",function(){var a=b.call(this);a.push(["energy :",
this.energy.toPrecision(4)].join(" "));return a}),e=override(d,"onDeath",function(a){e.call(a);delete this.energy;delete this.energyRecoverSpeed;delete this.maxEnergy})}};
Game.objects.properties.Homing={getSteeringForce:function(d,a,b,e,f){return Vec2.translation(d,f).normalize().mul(a).remove(e).clampMagnitude(0,b)},applyOnClass:function(d,a,b,e){var f=override(d,"onFrame",function(a,b){if(this.getTarget){var e=this.getTarget(a);if(isNull(e))this.setAcceleration(Vec2.ZERO),f.call(this,a,b);else{e instanceof Game.objects.Object&&(e=e.getPosition());var d=this.getPosition(),m=Vec2.translation(d,e),n=m.magnitude(),p=this.getMaxSpeed(n),q=this.getSteerForce(p,n),m=m.mul(q/
n);m.add(Game.objects.properties.Homing.getSteeringForce(d,p,q,this.getSpeed(),e)).normalize().mul(q);this.setAcceleration(m);f.call(this,a,b);this.setSpeed(this.getSpeed().clampMagnitude(0,p))}}else f.call(this,a,b)});isNull(e)||(d.prototype.getTarget=e);isNull(a)?d.prototype.getMaxSpeed=function(a){return 200}:d.prototype.getMaxSpeed=function(b){return a};isNull(b)?d.prototype.getSteerForce=function(a,b){return 100}:d.prototype.getSteerForce=function(a,e){return b}},applyOnObject:function(d,a,b,
e){var f=d.onFrame;d.onFrame=function(d,h){var k=e(d);if(isNull(k))this.setAcceleration(Vec2.ZERO);else{console.log(k);k instanceof Game.objects.Object&&(k=k.getPosition());var l=this.getPosition(),m=Vec2.translation(l,k).normalize().mul(steer);m.add(Homing.getSteeringForce(l,this.getSpeed(),a,b,this.getSpeed(),k));this.setAcceleration(m)}f.call(this,d,h)}}};
Game.objects.properties.LifeTime={applyOnClass:function(d){var a=d.prototype.onFrame;d.prototype.onFrame=function(b,e){exists(this.lifeTime)&&0>=this.lifeTime&&this.kill(b);a.call(this,b,e);exists(this.lifeTime)&&(this.lifeTime-=e)};var b=override(d,"getInformations",function(){if(isNull(this.lifeTime))return b.call(this);var a=b.call(this);a.push(["lifeTime :",this.lifeTime.toPrecision(4)].join(" "));return a}),e=override(d,"onDeath",function(a){e.call(a);delete this.lifeTime})},applyOnObject:function(d){var a=
d.onFrame;d.onFrame=function(b,e){exists(this.lifeTime)&&0>=this.lifeTime&&this.kill(b);a.apply(this,arguments);exists(this.lifeTime)&&(this.lifeTime-=e)};d.onDeath=function(a){exists(this.lifeTime)&&delete this.LifeTime}}};
Game.objects.properties.Tag=function(){var d=function(a,b){return b.hasTag&&b.hasTag(a)};return{canHaveTag:function(a){return a.hasTag},hasTag:function(a,b){return a.hasTag&&a.hasTag(b)},getAllObjectsWithTag:function(a,b){return isNull(b)?a.getObjects(canHaveTag):a.getObjects(d.bind(void 0,b))},applyOnClass:function(a){a.prototype.addTag=function(a){this.tags||(this.tags=[]);this.tags.push(a)};a.prototype.hasTag=function(a){return!isNull(this.tags)&&-1!==this.tags.indexOf(a)};a.prototype.getTags=
function(){return this.tags};a.prototype.isTagged=function(){return this.tags?!0:!1};var b=override(a,"getInformations",function(){var a=this.getTags();return!isNull(a)&&0<a.length?(a=b.call(this),a.push(["tags :",this.tags.join(", ")].join(" ")),a):b.call(this)}),e=override(a,"onDeath",function(a){e.call(a);exists(this.tags)&&delete this.tags})}}}();Game.objects.Follower=function(){var d=Game.objects.Object.Dynamic,a=function(a,e,f,g){d.call(this,a);this.maxSpeed=exists(f)?f:100;this.steerForce=exists(g)?g:f;this.setTarget(e)};classExtend(d,a);Game.objects.properties.Homing.applyOnClass(a);a.prototype.onDeath=function(a){var e=a.getGameEventsListener();if(e)e.onObjectDestroyed(a,this)};a.prototype.getMaxSpeed=function(){return this.maxSpeed};a.prototype.getSteerForce=function(){return this.steerForce};a.prototype.getTarget=function(){return this.target};
a.prototype.setTarget=function(a){this.target=a};return a}();
Game.objects.Vehicle=function(){var d=Game.objects.Object.Static,a=function(a){d.call(this,a);this.setRotationFieldEnabled(!0);this.speed=0};classExtend(d,a);a.prototype.moveOnFrame=function(a,e){this.speed&&this.move(this.copySpeed().mul(e))};a.prototype.accelerateOnFrame=function(a,e){this.accel&&(this.speed+=this.accel*e)};a.prototype.getSpeed=function(){return 0===this.speed?Vec2.ZERO:new Vec2(Math.cos(this.radians)*this.speed,Math.sin(this.radians)*this.speed)};a.prototype.copySpeed=function(){return 0===
this.speed?new Vec2:this.getSpeed()};a.prototype.getAcceleration=function(){return 0===this.accel?Vec2.ZERO:new Vec2(Math.cos(this.radians)*this.accel,Math.sin(this.radians)*this.accel)};a.prototype.copyAcceleration=function(){return 0===this.accel?new Vec2:new Vec2(Math.cos(this.radians)*this.accel,Math.sin(this.radians)*this.accel)};a.prototype.accelerate=function(a){this.speed+=a};a.prototype.setSpeed=function(a){this.speed=a};a.prototype.setAcceleration=function(a){this.accel=a};return a}();Game.objects.particles=function(){var d={};d.Particle=function(){var a=Game.objects.Object,b=function(b,e,d){a.call(this);this.lifeTime=b;this.shape=e;this.color=d};classExtend(a,b);Game.objects.properties.LifeTime.applyOnClass(b);var e=override(b,"onFrame",function(a,b){e.call(this,a,b);this.isOutOfMap(a.gameMap.getVisibleRect())&&(this.lifeTime=0)});b.prototype.render=function(a){a.fillStyle=this.color;this.shape.draw(a,!0)};b.prototype.getPosition=function(){return this.shape.center};b.prototype.copyPosition=
function(){return new Vec2(this.shape.center)};b.prototype.rotate=function(a){this.shape.rotate(a)};b.prototype.grow=function(a){this.shape.grow(a)};b.prototype.canCollide=function(){return!1};b.prototype.collides=function(){return!1};b.prototype.getRenderLayer=function(){return Game.Map.LAYER_PARTCILES};var d=[-1];b.prototype.getCollisionLayers=function(){return d};b.prototype.prepareCollision=function(){console.log("error")};delete b.prototype.renderMouseOver;return b}();d.Stroked=function(){var a=
d.Particle;StrokedParticle=function(b,e,d){a.call(this,b,e,d)};classExtend(a,StrokedParticle);StrokedParticle.prototype.render=function(a){a.strokeStyle=this.color;this.shape.draw(a,!1,!0)};return StrokedParticle}();d.Emitor=function(){var a=Game.objects.Object.Static,b=function(b,e){a.call(this);this.rate=b;this.emited=0;this.minLifeTime=.75;this.maxLifeTime=1.5;this.minAngle=0;this.maxAngle=2*Math.PI;this.minSpeed=300;this.maxSpeed=400;this.speedDampFactor=2.5;this.reduceSizeFactor=1.2;this.emitDistance=
0;e&&(this.max=e);this.particleGenerator=function(a,b){return new d.Particle(a,new Circle(b,5),"#"+Math.round(16777215*Math.random()).toString(16))};this.emitedParticles=[]};classExtend(a,b);b.prototype.restart=function(){this.emited=0};b.prototype.stop=function(){this.emited=-1};b.prototype.isRunning=function(){return 0<=this.emited};b.prototype.setAngles=function(a,b){this.setMinAngle(a);this.setMaxAngle(isNull(b)?a:b)};b.prototype.setMinAngle=function(a){this.minAngle=a};b.prototype.setMaxAngle=
function(a){this.maxAngle=a};b.prototype.getMinAngle=function(){return this.minAngle};b.prototype.getMaxAngle=function(){return this.maxAngle};b.prototype.setEmitDistance=function(a){this.emitDistance=a};b.prototype.getEmitDistance=function(){return this.emitDistance};b.prototype.setEmitRate=function(a){this.rate=a};b.prototype.getEmitRate=function(){return this.rate};b.prototype.setLifeTime=function(a,b){this.setMinLifeTime(a);this.setMaxLifeTime(b?b>a?b:a:a)};b.prototype.setMinLifeTime=function(a){this.minLifeTime=
a};b.prototype.setMaxLifeTime=function(a){this.maxLifeTime=a};b.prototype.getMinLifeTime=function(){return this.minLifeTime};b.prototype.getMaxLifeTime=function(){return this.maxLifeTime};b.prototype.setSpeedDampFactor=function(a){this.speedDampFactor=a};b.prototype.getSpeedDampFactor=function(){return this.speedDampFactor};b.prototype.setSizeReduceFactor=function(a){this.reduceSizeFactor=a};b.prototype.getSizeReduceFactor=function(){return this.reduceSizeFactor};var e=override(b,"rotate",function(a){e.call(this,
a);this.minAngle+=a;this.maxAngle+=a});b.prototype.getParticleGenerator=function(){return this.particleGenerator};b.prototype.setParticleGenerator=function(a){this.particleGenerator=a};var f=[-1];b.prototype.getCollisionLayers=function(){return f};b.prototype.getRenderLayer=function(){return Game.Map.LAYER_NONE};b.prototype.canCollide=function(a){return!1};var g=override(b,"onFrame",function(a,b){g.call(this,a,b);var e=this.emitedParticles.length,d=Math.max(0,1-this.speedDampFactor*b),f=Math.max(0,
1-this.reduceSizeFactor*b);if(0<e)for(;e--;)0>=this.emitedParticles[e].lifeTime?this.emitedParticles.splice(e,1):(this.emitedParticles[e].speed&&1!==d&&this.emitedParticles[e].speed.mul(d),1!==f&&this.emitedParticles[e].grow(f));this.max&&0===this.emitedParticles.length&&this.emited>=this.max&&this.kill(a);if(-1<this.emited&&(!this.max||this.emited<this.max)&&(d=this.emited+b*this.rate,this.max&&d>this.max&&(d=this.max),e=Math.floor(d-Math.floor(this.emited)),this.emited=d,0<e))for(;e--;){d=this.particleGenerator(Math.random()*
(this.maxLifeTime-this.minLifeTime)+this.minLifeTime,this.position);f=Math.round(Math.random()*(this.maxSpeed-this.minSpeed)+this.minSpeed);if(0<f){var p=Math.random()*(this.maxAngle-this.minAngle)+this.minAngle;this.emitDistance&&d.move(Vec2.createFromRadians(p).mul(this.emitDistance));d.speed=new Vec2(Math.cos(p)*f,Math.sin(p)*f)}this.emitedParticles.push(d);a.addObject(d)}if(this.particlePositionRelative&&this.speed&&!this.speed.isZero()&&(d=(new Vec2(this.speed)).mul(b),e=this.emitedParticles.length,
0<e))for(;e--;)this.emitedParticles[e].shape.move(d)});return b}();d.Explosion=function(){var a=d.Emitor,b=function(b){a.call(this,1E3*b,b);this.minLifeTime=.1;this.maxLifeTime=.5;this.minSpeed=500;this.maxSpeed=1500;this.speedDampFactor=2;this.reduceSizeFactor=3};classExtend(a,b);return b}();d.TraceDrawer=function(){TraceDrawer=function(a,b){this.lifeTime=a;this.color=b};TraceDrawer.prototype.applyOnObject=function(a,b){var e=b.setPosition,d=this;b.setPosition=function(){var g,h;1==arguments.length?
(g=arguments[0].x,h=arguments[0].y):(g=arguments[0],h=arguments[1]);var k=b.copyPosition();e.call(this,g,h);g=b.getPosition();if(!k.equals(g))d.onMove(a,k,g)}};TraceDrawer.applyOnClass=function(a){var b=a.prototype.moveOnFrame;a.prototype.moveOnFrame=function(a,d){if(this.traceDrawer){var g=this.copyPosition();b.call(this,a,d);var h=this.getPosition();if(!g.equals(h))this.traceDrawer.onMove(a,g,h)}else b.call(this,a,d)}};TraceDrawer.prototype.onMove=function(a,b,e){b=this.getParticlesForTranslation(b,
e);if(b.length)for(e=0;e<b.length;e++)a.addObject(b[e]);else a.addObject(b)};TraceDrawer.prototype.getParticlesForTranslation=function(a,b){return new d.Stroked(this.lifeTime,new Line(a,b),this.color)};return TraceDrawer}();return d}();Game.objects.bullets=function(){var d={},a=function(){var a=Game.objects.Object.Static,e=function(e,d,f,g){a.call(this,d);exists(f)&&(this.speed=new Vec2(f));this.damages=e;isNull(g)||(this.lifeTime=g)};classExtend(a,e);Game.objects.particles.TraceDrawer.applyOnClass(e);Game.objects.properties.LifeTime.applyOnClass(e);e.defaultTraceDrawer=new TraceDrawer(.05,"#FF0000");e.defaultShape=new Polygon([{x:-10,y:2},{x:5,y:2},{x:7,y:1},{x:8,y:0},{x:7,y:-1},{x:5,y:-2},{x:-10,y:-2}]);e.prototype.setLauncher=
function(a){this.launcher=a};e.prototype.getLauncher=function(){return this.launcher};e.prototype.getDamages=function(){return this.damages};e.prototype.setDamages=function(a){this.damages=a};e.prototype.onDeath=function(a){this.explosion&&(this.explosion.position.set(this.position),a.addObject(this.explosion))};var d=override(e,"moveOnFrame",function(a,b){d.call(this,a,b);this.isOutOfMap(a.gameMap.getVisibleRect())&&(delete this.explosion,this.kill(a))});e.COLLISION_LAYER=2;var g=[e.COLLISION_LAYER,
Game.objects.Object.COLLISION_LAYER];e.prototype.getCollisionLayers=function(){return g};e.prototype.onCollision=function(a,b){this.launcher!=b&&0!==this.damages&&(b.receiveDamages&&b.receiveDamages(a,this,this.damages)&&(this.damages=0),this.kill(a))};e.createBullet=function(a,b,d,f,g){a=new e(a,b,d);f=f.clone();f.rotate(d.getAngle());a.renderer=new GameObjectRenderer.Shaped(f.clone(),g);a.collider=new e.Collider(f);a.explosion=new ParticleEmitor.Explosion(20);a.traceDrawer=e.defaultTraceDrawer;
return a};e.prototype.getRenderLayer=function(){return Game.Map.LAYER_OBJ3};getInfo=override(e,"getInformations",function(){var a=getInfo.call(this);exists(this.lifeTime)&&a.push(["lifeTime : ",this.lifeTime].join(""));a.push(["damages : ",this.damages.toString()].join(""));return a});var h=override(e,"renderMouseOver",function(a,b,e,d){!e.running&&d&&h.call(this,a,b,e,d)});return e}();d.Bullet=a;d.Bullet.prototype=a.prototype;a=function(){var a=Game.objects.colliders.Shaped,e=function(e){a.call(this,
e)};classExtend(a,e);e.prototype.collidesWhenInside=function(a){return!0};return e}();d.Collider=a;d.Collider.prototype=a.prototype;a=function(){var a=d.Bullet,e=function(e,g,h,k,l){a.call(this,e,g,Vec2.ZERO,h);e=new Ray(g,l);this.renderer=new Game.objects.renderers.Shaped(e,k);this.collider=new d.Collider(e)};classExtend(a,e);return e}();d.Laser=a;d.Laser.prototype=a.prototype;a=function(){var a=d.Bullet,e=Game.objects.properties,f=function(e,d,f,g,h,k){a.call(this,e,d,f,k);this.maxSpeed=f.magnitude();
this.steerForce=g;this.maxAngle=h;this.setRotationFieldEnabled(!0)};classExtend(a,f);e.Homing.applyOnClass(f);f.prototype.getMaxSpeed=function(a){return this.maxSpeed*(1-Math.sqrt(this.maxSpeed/(150*a)))};f.prototype.getSteerForce=function(a,b){return a/Math.pow(b,1.2)*this.steerForce};var g=Game.objects.properties.Health.isDamageable,h=function(a,b){if(b.isInLayer(-1)||!g(b))return!1;for(var e=a.length,d=0;d<e;d++)if(b.isInLayer(a[d]))return!0;return!1};f.prototype.getTarget=function(a){var b,e=
this.maxAngle,d=this.getPosition();a=a.getObjects(h.bind(void 0,this.getCollisionLayers()));var f=a.length;if(0<f)for(;f--;)a[f]!==this.launcher&&(angle=(Vec2.translation(d,a[f].getPosition()).getAngle()-this.radians)%(2*Math.PI),angle>Math.PI&&(angle=2*Math.PI-angle),angle<e&&(e=angle,b=a[f]));return isNull(b)?null:b.getPosition()};var k=override(f,"onFrame",function(a,b){k.call(this,a,b);this.setRadians(this.getSpeed().getAngle())});return f}();d.Homing=a;d.Homing.prototype=a.prototype;return d}();Game.objects.interactives=function(){var d={};d.obstacles=function(){var a={};a.Obstacle=function(){var a=Game.objects.Object.Static,e=function(e){a.call(this,e)};classExtend(a,e);e.prototype.onCollision=function(a,b){};e.prototype.repulse=function(a,b){a.move(b);var e=a.copySpeed(),d=b.getAngle();e.rotate(-d);e.x=0;e.rotate(d);a.setSpeed(e)};e.COLLISION_LAYER=1;var d=[e.COLLISION_LAYER,Game.objects.Object.COLLISION_LAYER];e.prototype.getCollisionLayers=function(){return d};return e}();a.Rectangular=
function(){var b=a.Obstacle,e=function(a){b.call(this,a)};classExtend(b,e);e.prototype.disableBelow=function(a){this.enableBelowCross=a};e.prototype.disableAbove=function(a){this.enableAboveCross=a};e.prototype.disableLeft=function(a){this.enableLeftCross=a};e.prototype.disableRight=function(a){this.enableRightCross=a};e.prototype.onCollision=function(a,b){var e=this.getRadians(),d,l,m=b.getPosition();d=this.getPosition();var n=b.getSpeed();0!==e&&(this.getCollider().rotate(-e),b.getCollider().rotate(-e),
m=Vec2.translation(d,m).rotate(-e).add(d),n=(new Vec2(n)).rotate(-e));d=b.getCollider().getRect(m);l=this.getCollider().getRect();var p=new Vec2;!this.enableAboveCross&&l.below(m)&&-.01<=n.y?p.y=l.top-d.bottom:!this.enableBelowCross&&l.above(m)&&.01>=n.y&&(p.y=l.bottom-d.top);!this.enableRightCross&&l.onLeftOf(m)&&.01>=n.x?p.x=l.right-d.left:!this.enableLeftCross&&l.onRightOf(m)&&-.01<=n.x&&(p.x=l.left-d.right);0!==e&&(this.getCollider().rotate(e),b.getCollider().rotate(e),p.rotate(e));p.equals(Vec2.ZERO)||
this.repulse(b,p)};return e}();a.Circular=function(){var b=a.Obstacle,e=function(a){b.call(this,a)};classExtend(b,e);e.prototype.onCollision=function(a,b){var e=this.getPosition(),d=b.getPosition(),l=Vec2.translation(e,d),m=l.getAngle(),n=e.x+this.getCollider().getRadius(),p=b.getSpeed();0!==m&&(b.getCollider().rotate(-m),d=l.rotate(-m).add(e),p=(new Vec2(p)).rotate(-m));0>=p.x?(e=b.getCollider().getRect(d),n=new Vec2(n-e.left,0),0!==m&&(b.getCollider().rotate(m),n.rotate(m)),n.equals(Vec2.ZERO)||
this.repulse(b,n)):0!==m&&b.getCollider().rotate(m)};return e}();a.properties={Bumper:{applyOnObstacle:function(a,e){var d=a.repulse;a.repulse=function(a,b){var e=a.copySpeed();d.call(this,a,b);var l=b.getAngle();e.rotate(-l);e.x=-e.x*this.getBumperStrength();40<Math.abs(e.x)&&(e.rotate(l),a.setSpeed(e))};a.setBumperStrength=function(a){this.bumperStrength=a};a.getBumperStrength=function(){return this.bumperStrength};exists(e)&&a.setBumperStrength(e)},applyOnObstacleClass:function(a,e){var d=override(a,
"repulse",function(a,b){var e=a.copySpeed();d.call(this,a,b);var l=b.getAngle();e.rotate(-l);e.x=-e.x*this.getBumperStrength();40<Math.abs(e.x)&&(e.rotate(l),a.setSpeed(e))});a.prototype.setBumperStrength=function(a){this.bumperStrength=a};a.prototype.getBumperStrength=function(){return this.bumperStrength};exists(e)&&(a.prototype.bumperStrength=e)}}};return a}();return d}();Game.weapons=function(){var d={};d.Weapon=function(){var a=function(a,e){this.damages=a;isNull(e)||this.setOwner(e)};a.prototype.use=function(a,e,d){};a.prototype.setOwner=function(a){this.owner=a};a.prototype.getOwner=function(){return this.owner};a.prototype.getDamages=function(){return this.damages};a.prototype.setDamages=function(a){this.damages=a};a.prototype.onDeath=function(){delete this.damages;this.owner&&delete this.owner};a.applyOnClass=function(a){a.prototype.setWeapon=function(a){isNull(a)?
exists(this.weapon)&&delete this.weapon:this.weapon=a};a.prototype.getWeapon=function(){return this.weapon};a.prototype.useWeapon=function(a){isNull(this.weapon)||this.weapon.use(a,this.getPosition(),this.getRadians())};var e=override(a,"onDeath",function(a){exists(this.weapon)&&(this.weapon.onDeath(),delete this.weapon);e.call(this,a)})};a.applyOnObject=function(a){a.setWeapon=function(a){isNull(a)?exists(this.weapon)&&delete this.weapon:this.weapon=a};a.getWeapon=function(){return this.weapon};
a.useWeapon=function(a){exists(this.weapon)&&this.weapon.use(a,this.getPosition(),this.gertRadians())};var e=a.onDeath;a.onDeath=function(a){exists(this.weapon)&&(this.weapon.onDeath(),delete this.weapon);e.call(this,a)}};return a}();d.Gun=function(){var a=d.Weapon,b=function(b,e,d){a.call(this,b,d);this.bulletGenerator=e};classExtend(a,b);b.prototype.createBullet=function(a,b){var e=this.bulletGenerator(this.getDamages(),a,b),d=this.getOwner();d&&e.setLauncher(d);return e};b.prototype.use=function(a,
b,e){a.addObject(this.createBullet(b,e))};b.defaultBulletValues={renderShape:Game.objects.bullets.Bullet.defaultShape,colliderShape:Game.objects.bullets.Bullet.defaultShape,color:"#0F0",speed:300,spawnDistance:5,explosionSize:0};b.createBulletGenerator=function(a){var e=createProperties(b.defaultBulletValues,a);return function(a,b,d){var f=Vec2.createFromRadians(d).mul(e.speed);a=new Game.objects.bullets.Bullet(a,b,f,e.lifeTime);a.renderer=new Game.objects.renderers.Shaped(e.renderShape,e.color);
a.collider=new Game.objects.colliders.Shaped(e.colliderShape);d&&a.rotate(d);isNull(e.trace)||(a.traceDrawer=e.trace);isNull(e.explosionSize)||(a.explosion=new Game.objects.particles.Explosion(e.explosionSize));return a}};b.defaultHomingBulletValues=createProperties(b.defaultBulletValues);b.defaultHomingBulletValues.maxAngle=Math.PI/8;b.createHomingBulletGenerator=function(a){var e=createProperties(b.defaultHomingBulletValues,a);exists(e.steerForce)||(e.steerForce=Math.pow(e.speed,1.6)/(10/Math.log(1+
e.maxAngle)));return function(a,b,d){var f=Vec2.createFromRadians(d).mul(e.speed);a=new Game.objects.bullets.Homing(a,b,f,e.steerForce,e.maxAngle,e.lifeTime);a.renderer=new Game.objects.renderers.Shaped(e.renderShape,e.color);a.collider=new Game.objects.colliders.Shaped(e.colliderShape);d&&a.rotate(d);isNull(e.trace)||(a.traceDrawer=e.trace);isNull(e.explosionSize)||(a.explosion=new Game.objects.particles.Explosion(e.explosionSize));return a}};b.createLaserBulletGenerator=function(a,b,e){var d;d=
exists(e)?new Line(Vec2.ZERO,{x:e,y:0}):new Ray(Vec2.ZERO,0);return function(b,g,n){isNull(e)||(g=Vec2.createFromRadians(n).mul(e/2).add(g));b=new Game.objects.bullets.Bullet(b,g,Vec2.ZERO,.01);b.renderer=new Game.objects.renderers.Shaped(d,a);b.renderer.fill=!1;b.renderer.stroke=!0;b.collider=new Game.objects.colliders.Shaped(d);b.rotate(n);return b}};var e=override(b,"onDeath",function(){e.call(this);delete this.bulletGenerator});return b}();return d}();Game.Physics=function(){var d={G:6.67384E-11,friction:2,Mass:{applyOnClass:function(a,b){a.prototype.mass=exists(b)?b:0;a.prototype.setMass=function(a){this.mass=a};a.prototype.getMass=function(){return this.mass};a.prototype.applyForce=function(a){a=(new Vec2(a)).mul(this.getMass());a.add(this.copyAcceleration());this.setAcceleration(a)}},applyOnObject:function(a,b){a.setMass=function(a){this.mass=a};a.getMass=function(){return this.mass};a.applyForce=function(a){a=(new Vec2(a)).mul(this.getMass());
a.add(this.copyAcceleration());this.setAcceleration(a)}},hasMass:function(a){return exists(a.getMass)},elasticCollision:function(a,b){var e=this.hasMass(a)?a.getMass():1,d=this.hasMass(b)?b.getMass():1,g=a.getPosition(),h=a.getSpeed(),k=b.getPosition(),l=b.getSpeed(),g=Vec2.translation(g,k).mul(Vec2.distance(h,l)/(e+d));a.setSpeed((new Vec2(g)).mul(d));b.setSpeed(g.mul(e));console.log(g)}},applyForce:function(a,b){a.setAcceleration(a.getAcceleration().add(b))},applyGravity:function(a,b){d.applyForce(a,
(new Vec2(b)).mul(9.81))},applyFriction:function(a){a.speed&&d.applyForce(a,(new Vec2(a.speed)).mul(friction))},applySpaceGravity:function(a,b){var e=b.mass|1,f=a.mass|1,g=Vec2.translation(a,b),e=d.G*e*f/g.squareMagnitude();d.applyForce(a,g.normalize().mul(e))}};return d}();Game.hud={};
Game.hud.Hud=function(){var d=function(a){this.views=[];this.currentView=null;a&&(this.context2d=a.getContext("2d"),a.style.background="#00000000")};d.prototype.addView=function(a){this.views.push(a)};d.prototype.removeView=function(a){a=this.views.indexOf(a);0<=a&&this.views.splice(a,1)};d.prototype.onRectUpdate=function(a){for(var b=0;b<view.length;b++)v.onRectUpdate(a)};d.prototype.updateRect=function(a){requestAnimationFrame(this.render.bind(this,this.context2d,a?a:new Rect(0,0,this.context2d.canvas.width,this.context2d.canvas.height)))};
d.prototype.getChildRect=function(a){return a.getRect()};d.prototype.getContext=function(){return this.context2d};d.prototype.render=function(a,b){for(var e=this.views.length,d=0;d<e;)this.views[d++].render(a,b)};d.prototype.mouseButton=function(a,b){return!isNull(this.currentView)&&this.currentView.onTouchEvent({position:position,description:b?Game.hud.views.EVENT_DESC.DOWN:Game.hud.views.EVENT_DESC.UP,button:a})};d.prototype.mouseMove=function(a){for(var b,e,d=!1,g={description:Game.hud.views.EVENT_DESC.MOVE,
position:new Vec2},h=this.views.length-1;0<=h;h--)if(e=this.views[h],!(d&&e!=this.currentView||e.state&Game.hud.views.STATE.INACTIVE)){b=e.getRect();g.position.set(a).add(-b.left,-b.top);if(d&&e==this.currentView){this.currentView.onTouchEvent(g);break}if(e.onTouchEvent(g)){if(isNull(this.currentView)){this.currentView=e;break}d=!0;g.description=Game.hud.views.EVENT_DESC.EXIT}}};d.prototype.click=function(a,b){console.log("onClick");return!isNull(this.currentView)&&this.currentView.onTouchEvent({position:a,
description:Game.hud.views.EVENT_DESC.CLICK,button:b})};return d}();Game.hud.views={STATE:{INACTIVE:1,NONE:2,OVERED:4,PRESSED:8},EVENT_DESC:{MOVE:0,ENTER:1,EXIT:2,SCROLL:3,DOWN:4,UP:5,CLICK:6},TouchEvent:function(d,a,b,e){this.position=d;this.description=a;a==Game.hud.views.EVENT_DESC.SCROLL&&(this.scroll=b);a>=Game.hud.views.EVENT_DESC.DOWN&&(this.btn=b,this.pressed=e)}};
Game.hud.views.View=function(){var d=function(a){this.parentView=a;this.state=Game.hud.views.STATE.INACTIVE};d.prototype.render=function(a,e){};d.prototype.getState=function(){return this.state};d.prototype.setState=function(a){this.state=a};d.prototype.getParentView=function(){return this.parentView};d.prototype.setParentView=function(a){this.parentView=a};d.prototype.onRectUpdate=function(a){};d.prototype.getPosition=function(){return new Vec2(Vec2.ZERO)};d.prototype.containsPoint=function(a){return!1};
d.prototype.getRect=function(){return Rect.createFromPoint(this.getPosition())};d.prototype.onClick=function(a,e){return!1};var a=Game.hud.views.EVENT_DESC;d.prototype.onTouchEvent=function(b){switch(b.description){case a.DOWN:return this.state|=views.STATE.PRESSED,!0;case a.UP:return this.state&=views.STATE.OVERED,!1;case a.CLICK:return this.onClick(b.position,b.btn);case a.MOVE:return isPressed();case a.ENTER:return this.state=views.STATE.OVERED,!1;case a.EXIT:return this.state=views.STATE.NONE,
isPressed()}};d.update=function(){var a=this.getParentView();isNull(a)||a.updateRect(a.getChildRect(this))};d.prototype.isOvered=function(){return 0!==(this.state&Game.hud.views.STATE.OVERED)};d.prototype.isPressed=function(){return 0!==(this.state&Game.hud.views.STATE.PRESSED)};d.prototype.hasFocus=function(){return this.isHovered()||this.isPressed()};d.prototype.toString=function(){return"hud.views.View"};return d}();
Game.hud.views.TextView=function(){var d=Game.hud.views.View,a=function(a,e,f,g){d.call(this,a);this.setText(e);isNull(f)||this.setRect(f);this.setFontSize(12);this.setFont("Verdana");isNull(g)||this.setTextColor(g)};classExtend(d,a);a.prototype.setText=function(a){this.text=a};a.prototype.getText=function(){return this.text};a.prototype.setFontSize=function(a){this.fontSize=a};a.prototype.getFontSize=function(){return this.fontSize};a.prototype.setFont=function(a){this.font=a};a.prototype.getFont=
function(){return this.font};a.prototype.setTextColor=function(a){this.textColor=a};a.prototype.getTextColor=function(){return this.textColor};a.prototype.setRect=function(){this.rect=rect};a.prototype.getRect=function(){return this.rect};a.prototype.getPosition=function(){return getRect().center()};a.prototype.containsPoint=function(a){return this.getRect().contains(a)};a.prototype.render=function(a,e){var d=this.getRect();isNull(d)&&(d=e);this.getState()&Game.hud.views.STATE.OVERED&&(a.lineWidth*=
2,a.strokeStyle="#fff",d.draw(a,this.fill,!0),a.lineWidth/=2);a.strokeStyle=this.getTextColor();var g=this.getFontSize();a.font=[g,"px ",this.getFont()].concat();a.wrapText(this.getText(),d,1.25*this.getFontSize(),Gravity.CENTER)};return a}();
Game.hud.views.Button=function(){var d=Game.hud.views.TextView,a=function(a,b,g,h,k){isNull(k)&&(k="black");d.call(this,a,h,void 0,k);this.setShape(b);this.setShapeColor(g);this.stroke=!0;this.fill=!1;this.setGravity(Gravity.LEFT|Gravity.TOP)};classExtend(d,a);a.prototype.setShape=function(a){this.shape=a.clone()};a.prototype.getShape=function(){return this.shape};a.prototype.getPosition=function(){return this.getShape().center};a.prototype.getRect=function(){return this.getShape().getRect()};a.prototype.setGravity=
function(a){this.gravity=a};a.prototype.getGravity=function(){return isNull(this.gravity)?Gravity.LEFT|Gravity.TOP:gravity};a.prototype.onClick=function(){return!0};a.prototype.getShapeColor=function(){return this.shapeColor};a.prototype.setShapeColor=function(a){this.shapeColor=a};a.prototype.setStroke=function(a){this.stroke=a};a.prototype.setFill=function(a){this.fill=a};a.prototype.containsPoint=function(a){return this.getShape().contains(a)};var b=override(a,"render",function(a,d){a.fillStyle=
a.strokeStyle=this.getShapeColor();this.getState()&Game.hud.views.STATE.OVERED?(a.lineWidth*=2,a.strokeStyle="#fff",this.getShape().draw(a,this.fill,!0),a.lineWidth/=2):this.getShape().draw(a,this.fill,this.stroke);b.call(this,a)});return a}();
Game.hud.views.ProgressBar=function(){var d=Game.hud.views.View,a=function(a,e,f,g,h){d.call(this,a);this.needFillUpdate=this.needStrokeUpdate=!0;this.setWidth(e);this.setHeight(f);this.setMax(g);this.setValue(h);this.setMargins(0,0);this.setGravity(Gravity.LEFT|Gravity.TOP);this.setColor("#f00")};classExtend(d,a);a.prototype.createShape=function(a,e){var d=a?this.getWidth():this.getWidth()/this.getMax()*this.getValue(),g=this.getHeight(),h=this.getGravity(),k=NaN,l=NaN,m=NaN,n=NaN;(h&Gravity.RIGHT)===
Gravity.RIGHT?n=e.right-this.getMarginX():k=(h&Gravity.LEFT)===Gravity.LEFT||(h&Gravity.CENTER)!==Gravity.CENTER?e.left+this.getMarginX():e.left+(canvasrect.width()-d)/2;(h&Gravity.BOTTTOM)===Gravity.BOTTOM?m=e.bottom-this.getMarginY():l=(h&Gravity.TOP)===Gravity.TOP||(h&Gravity.CENTER)!==Gravity.CENTER?e.top+this.getMarginY():e.top+(e.height()-g)/2;isNaN(k)?k=n-d:isNaN(n)&&(n=k+d);isNaN(l)?l=m-g:isNaN(m)&&(m=l+g);return(new Rect(k,l,n,m)).getShape()};a.prototype.setGravity=function(a){this.gravity=
a;this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getGravity=function(){return this.gravity};a.prototype.getStrokeShape=function(a){this.needStrokeUpdate&&!isNull(a)&&(this.strokeShape=this.createShape(!0,a),this.needStrokeUpdate=!1);return this.strokeShape};a.prototype.getFillShape=function(a){this.needFillUpdate&&!isNull(a)&&(this.fillShape=this.createShape(!1,a),this.needFillUpdate=!1);return this.fillShape};a.prototype.setWidth=function(a){this.width=a;this.needStrokeUpdate=this.needFillUpdate=
!0};a.prototype.getWidth=function(){return this.width};a.prototype.setHeight=function(a){this.height=a;this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getHeight=function(){return this.height};a.prototype.setMax=function(a){this.max=a;this.needFillUpdate=this.needStrokeUpdate=!0};a.prototype.getMax=function(){return this.max};a.prototype.setValue=function(a){this.value=a;this.needFillUpdate=!0};a.prototype.getValue=function(){return this.value};a.prototype.setMargins=function(a,e){isNaN(a)||
(this.marginX=a);isNaN(e)||(this.marginY=e);this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getMarginX=function(){return this.marginX};a.prototype.getMarginY=function(){return this.marginY};a.prototype.setColor=function(a){this.color=a};a.prototype.getColor=function(){return this.color};a.prototype.onRectUpdate=function(a){this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getPosition=function(){return this.getStrokeShape().center};a.prototype.getRect=function(){return this.getStrokeShape().getRect()};
a.prototype.containsPoint=function(a){var e=this.getStrokeShape();return!isNull(e)&&e.contains(a)};a.prototype.render=function(a,e){var d=this.getStrokeShape(e),g=this.getFillShape(e),h=this.getColor();a.fillStyle=h;g.draw(a,!0,!1);this.getState()&Game.hud.views.STATE.OVERED?(a.lineWidth*=2,a.strokeStyle="#fff",d.draw(a,!1,!0),a.lineWidth/=2):(a.strokeStyle=h,d.draw(a,!1,!0))};return a}();
Game.hud.views.SegmentedProgressBar=function(){var d=Game.hud.views.ProgressBar,a=function(a,e,f,g,h,k,l){d.call(this,a,e,f,g,h);this.setSegments(k);this.setInclination(l)};classExtend(d,a);a.prototype.setSegments=function(a){this.segments=a;this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getSegments=function(){return this.segments};a.prototype.setInclination=function(a){this.inclination=a;this.needStrokeUpdate=this.needFillUpdate=!0};a.prototype.getInclination=function(){return this.inclination};
a.prototype.createShape=function(a,e){var d=this.getHeight(),g=this.getInclination(),h=this.getSegments(),k=this.getWidth()-g*d,l=k/h,m=d/h,n=m*g,d=[new Vec2(g*d,0),new Vec2(0,d)],p;if(a)for(g=1;g<h+1;g++)p=2*g,d.push(new Vec2(d[p-1].x+l,d[p-1].y)),d.push(new Vec2(d[p].x+n,d[p].y-m));else for(var q=this.getValue(),r=this.getMax(),g=1;g<h+1;g++)p=2*g,q>r*g/h?(d.push(new Vec2(d[p-1].x+l,d[p-1].y)),d.push(new Vec2(d[p].x+n,d[p].y-m))):(n=(q-r*(g-1)/h)*k/r,d.push(new Vec2(d[p-1].x+n,d[p-1].y)),d.push(new Vec2(d[0].x+
q/r*k,0)));h=new Polygon(d);h.move(e.left+this.getMarginX(),e.top+this.getMarginY());k=this.getGravity();k&Gravity.BOTTOM&&h.mirrorVertically((e.top+e.bottom)/2);k&Gravity.RIGHT&&h.mirrorHorizontally((e.left+e.right)/2);return h};return a}();Game.hud.views.Layout=function(){var d=function(){this.children=[];this.currentView=null;this.rect=new Rect(0,0,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER);this.setState(Game.hud.views.STATE.NONE)};d.prototype.addView=function(a,d){a.layoutParams=d;this.addView(a)};d.prototype.addView=function(a){a.layoutRule||(a.layoutParams=this.getDefaultLayoutParams());this.children.push(a)};d.prototype.getDefaultLayoutParams=function(){return{}};d.prototype.onTouchEvent=function(a){if(a.description<=Game.hud.views.EVENT_DESC.EXIT)return this.mouseMove(a);
if(!isNull(currentView))return currentView.onTouchEvent(a)};d.prototype.updateRect=function(a){this.getParentView().updateRect(a)};d.mouseMove=function(a){for(var d,f,g=!1,h=this.views.length;h--;)if(f=this.views[h],!(g&&f!=currentView||f.state&Game.hud.views.STATE.INACTIVE)){d=f.getRect();a.position.set(position).add(-d.left,-d.top);if(g&&f==currentView){currentView.onTouchEvent(a);break}if(f.onTouchEvent(a)){if(isNull(currentView)){currentView=f;break}g=!0;a.description=Game.hud.views.EVENT_DESC.EXIT}}};
var a=override(d,"render",function(b){a.call(this,b);b.save();b.translate(this.rect.left,this.rect.top);var d=this.getRect();b.rect(0,0,d.width(),d.height());b.clip();for(var d=this.children.length,f,g,h=0;h<d;h++)g=this.children[h],f=(new Vec2(this.getChildPosition(g))).remove(g.getPosition()),f.isZero()?g.render(b):(b.save(),b.translate(f.x,f.y),g.render(b),b.restore())});d.prototype.getIndexOf=function(a){return this.children.indexOf(a)};d.prototype.getChild=function(a){return this.children[a]};
d.prototype.getChildPosition=function(a){return isNaN(a)?a.getPosition:this.getChildPosition(this.getChild(a))};d.prototype.getChildRect=function(a){return isNaN(a)?a.getRect():this.getChild(a).getRect()};return d};
Game.hud.views.LinearLayout=function(){var d=function(a,b){this.horizontal=a;this.rtl=b};override(d,"getPosition",function(a){isNaN(a)&&(a=this.getIndexOf(a));var b=(new Vec2(this.getChild(a).getPosition())).add();0<a&&b.add(0,this.getChildRect(a-1).bottom);return b});override(d,"getRect",function(a){isNaN(a)&&(a=this.getIndexOf(a));var b=getChildAt(a).getRect();0<a?(a=this.getChildRect(a-1),this.horizontal?b.move(rtl?-a.left:a.right,0):b.move(0,rtl?-a.top:a.bottom)):rtl&&(this.horizontal?b.move(this.getRect().width()-
b.width(),0):b.move(0,this.getRect().height()-b.height()));return b});return d}();